"use strict";!function(){$xirsys.class.create({namespace:"api",constructor:function(e,t){t&&(this.url=t+"?type=ice"),this.data=e},fields:{ice:null},methods:{getIceServers:function(e){var t=this,n=t.xirsys_opts;console.log("TURN OPTS ARE",n),$xirsys.ajax.do({url:(this.url||$xirsys.api.iceUrl)+"/"+n.channel,headers:$xirsys.authHeader(n),method:"PUT",data:JSON.stringify({})}).done(function(n){t.ice=n.v,e.apply(this,[t.ice])})}},statics:{iceUrl:$xirsys.url("_turn")}})}();var $xirsys={class:{},baseUrl:"ws.xirsys.com"};!function(){$xirsys.extend=function(e,t){for(var n in t)"object"==typeof t[n]&&null!==t[n]?(e[n]=e[n]||{},arguments.callee(e[n],t[n])):e[n]=t[n];return e},$xirsys.url=function(e,t){var n=t?"?"+$xirsys.parseParams(t):"";return"https://"+$xirsys.baseUrl+"/"+e+n},$xirsys.parseParams=function(e){var t=[];for(var n in e)t.push(n+"="+e[n]);return t.join("&")},$xirsys.authHeader=function(e){return{Authorization:"Basic "+btoa(e.ident+":"+e.secret)}},$xirsys.isArray=function(e){return!!e&&e.constructor==Array},$xirsys.isString=function(e){return"string"==typeof e},$xirsys.class.create=function(e){var t,n,s,r,i,a=[],o=function(){},c={},l={},d={},u=$xirsys,h=Object.prototype.hasOwnProperty;if(!e)return function(){};if(!(n=e.namespace))throw new Error("Please specify the Namespace.");if(0==n.length||n.indexOf(" ")!=-1||"."==n.charAt(0)||"."==n.charAt(n.length-1)||n.indexOf("..")!=-1)throw new Error("Illegal Namespace: "+n);for(a=n.split("."),t=0;t<a.length;t++)u&&(u=u[a[t]]);if(u)return u;if(h.call(e,"constructor")){if("function"!=typeof e.constructor)throw new TypeError("Illegal function ["+n+".constructor]!");o=e.constructor}for(e.inherits&&(this.inherits=function(e,t){for(s in t)h.call(t,s)&&(e[s]=t[s]);c=function(){this.constructor=e},c.prototype=t.prototype,e.prototype=new c,e.__super__=e.Super=t.prototype,s=t=c=e=null},this.inherits(o,e.inherits)),l=function(e,t,n){for(s in t)h.call(t,s)&&(n?e[s]=t[s]:e.prototype[s]=t[s])},e.methods&&l(o,e.methods),e.fields||(e.fields={}),e.fields.className=n,l(o,e.fields),e.statics&&l(o,e.statics,!0),e.props&&(d=o.prototype.props=$.extend(!0,{},o.prototype.props),l(d,$.extend(!0,{},e.props),!0)),u=$xirsys,t=0;t<a.length-1;t++){if(r=a[t],u[r]){if("object"!=typeof u[r])throw i=a.slice(0,t).join("."),new Error(i+" already exists and is not an object")}else u[r]={};u=u[r]}return u[a[a.length-1]]=o,n=a=h=u=l=t=null,o},$xirsys.class.create({namespace:"ajax",fields:{host:{},xhr:null},methods:{request:function(e){return"string"==typeof e&&(e={url:e}),e.url=e.url||"",e.method=e.method||"get",e.data=e.data||{},this.process(e)},getParams:function(e,t){var n,s=[];for(var r in e)s.push(r+"="+encodeURIComponent(e[r]));return n=s.join("&"),""!=n?t?t.indexOf("?")<0?"?"+n:"&"+n:n:""},extend:$xirsys.extend,done:function(e){return this.doneCallback=e,this},fail:function(e){return this.failCallback=e,this},always:function(e){return this.alwaysCallback=e,this},setHeaders:function(e){for(var t in e)this.xhr&&this.xhr.setRequestHeader(t,e[t])},process:function(e){var t=this;return window.ActiveXObject?this.xhr=new ActiveXObject("Microsoft.XMLHTTP"):window.XMLHttpRequest&&(this.xhr=new XMLHttpRequest),this.xhr&&(this.xhr.onreadystatechange=function(){if(4==t.xhr.readyState&&t.xhr.status>=200&&t.xhr.status<300){var n=t.xhr.responseText;e.json&&e.json!==!0||"undefined"==typeof JSON||(n=JSON.parse(n)),t.doneCallback&&t.doneCallback.apply(t.host,[n,t.xhr])}else 4==t.xhr.readyState&&t.failCallback&&t.failCallback.apply(t.host,[t.xhr]);t.alwaysCallback&&t.alwaysCallback.apply(t.host,[t.xhr])}),"get"==e.method.toLowerCase()?this.xhr.open("GET",e.url+t.getParams(e.data,e.url),!0):(this.xhr.open(e.method,e.url,!0),console.log("SETTEING HEADERS for ",e.method),this.setHeaders({"X-Requested-With":"XMLHttpRequest","Content-type":"application/json"})),e.headers&&"object"==typeof e.headers&&this.setHeaders(e.headers),setTimeout(function(){"get"==e.method?t.xhr.send():t.xhr.send(e.data)},20),this}},statics:{inst:null,do:function(e){return(new $xirsys.ajax).request(e)}}}),$xirsys.class.create({namespace:"events",fields:{delimiter:".",wildcard:"*",_stack:{}},methods:{on:function(e,t){var n=$xirsys.events.getInstance()._getNamespaceSegment(e);this.has(e,t)||n._handlers.push(t)},remove:function(e,t){var n=$xirsys.events.getInstance()._getNamespaceSegment(e);n._handlers=n._handlers||[];for(var s=0;s<n._handlers.length;s++)if(n._handlers[s]==t||t===-1)return void n._handlers.splice(s)},flush:function(e){if($xirsys.isArray(e))for(var t=0;t<e.length;t++)e[t]&&this.removeAllListeners(e[t]);else e[t]&&this.removeListener(e[t],-1)},has:function(e,t){if(!t||"function"!=typeof t)throw"Event handler must be supplied as a function";var n=$xirsys.events.getInstance()._getNamespaceSegment(e);n._handlers||(n._handlers=[]);for(var s=!1,r=0;r<n._handlers.length;r++)n._handlers[r]==t&&(s=!0);return s},emit:function(e){for(var t=$xirsys.events.getInstance()._getNamespaceSegment(e,!0),n=Array.prototype.slice.call(arguments,0),s=0;s<t.length;s++)for(var r=0;r<t[s]._handlers.length;r++)t[s]._handlers[r].apply(this,n)},_getNamespaceSegment:function(e,t,n){var s=$xirsys.isString(e)?e.split(this.delimiter):$xirsys.isArray(e)?e:null;if(!s)throw"Event listener assigned to unknown type";for(var r=this._stack,i=0;i<s.length;i++){if(!$xirsys.isString(s[i]))throw"Event identifier segment not a string value";if("_handlers"==s[i]||s[i]==this.wildcard&&i<s.length-1)throw"Invalid name used in event namespace.";r=r[s[i]]=r[s[i]]||{}}return r._handlers=r._handlers||[],t?(n&&$xirsys.isArray(n)||(n=[]),n.push(r),s[s.length-1]==this.wildcard&&s.pop(),s.length>0&&(s.pop(),s.push(this.wildcard),this._getNamespaceSegment(s,t,n)),n):r}},statics:{_instance:null,getInstance:function(){return $xirsys.events._instance=$xirsys.events._instance||new $xirsys.events}}})}(),function(){$xirsys.class.create({namespace:"databind",inherits:$xirsys.events,constructor:function(e,t){this.init(e,t)},methods:{init:function(e,t){this.id=e,this.cb=t,this.attr="data-bind-"+e,this.msg=e+":change",document.addEventListener?document.addEventListener("change",this.change_handler.bind(this),!1):document.attachEvent("onChange",this.change_handler.bind(this)),$xirsys.events.getInstance().on(this.msg,this.msg_handler.bind(this))},change_handler:function(e){var t=e.target||e.srcElement,n=t.getAttribute(this.attr);n&&""!==n&&$xirsys.events.getInstance().emit(this.msg,n,t.value)},msg_handler:function(e,t,n){var s,r=document.querySelectorAll("["+this.attr+"='"+t+"']");this.cb&&this.cb.call(this,n);for(var i=0,a=r.length;i<a;i++)s=r[i].tagName.toLowerCase(),"input"===s||"textarea"===s||"select"===s?r[i].value=n:r[i].innerHTML=n}}})}(),function(){var e=$xirsys.class.create({namespace:"model",inherits:$xirsys.databind,constructor:function(t,n){e.Super.init.call(this,t,n),this.id=t},fields:{attrs:{}},methods:{set:function(e,t){this.attrs[e]=t,$xirsys.events.getInstance().emit(this.id+":change",e,t,this)},get:function(e){return this.attrs[e]}}})}();var RTCPeerConnection=RTCPeerConnection||null,RTCIceCandidate=RTCIceCandidate||null,RTCSessionDescription=RTCSessionDescription||null,getUserMedia=getUserMedia||null,attachMediaStream=null,detachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null;navigator.mozGetUserMedia?(console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),attachMediaStream=function(e,t){console.log("Attaching media stream"),e.mozSrcObject=t,e.play()},detachMediaStream=function(e){console.log("detaching media stream"),e.pause(),e.mozSrcObject=null},reattachMediaStream=function(e,t){console.log("Reattaching media stream"),e.mozSrcObject=t.mozSrcObject,e.play()},MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]})):navigator.webkitGetUserMedia?(console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(e,t){void 0!==e.srcObject?e.srcObject=t:void 0!==e.mozSrcObject?e.mozSrcObject=t:void 0!==e.src?e.src=URL.createObjectURL(t):console.log("Error attaching stream to element.")},detachMediaStream=function(e){console.log("detaching media stream"),e.pause(),void 0!==e.srcObject?e.srcObject=null:void 0!==e.mozSrcObject?e.mozSrcObject=null:void 0!==e.src&&(e.src=null)},reattachMediaStream=function(e,t){e.src=t.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):console.log("Browser does not appear to be WebRTC-capable"),function(){$xirsys.class.create({namespace:"p2p",constructor:function(e,t,n,s){this.status=$xirsys.p2p.DISCONNECTED,void 0!==t.video&&(this.rtc.useVideo=!!t.video),void 0!==t.audio&&(this.rtc.useAudio=!!t.audio),this.rtc.useDataChannel=!!t.dataChannels,this.rtc.useDataChannel&&(this.rtc.dataChannelList=t.dataChannels),this.rtc.forceTurn=!!t.forceTurn,this.rtc.screenshare=!!t.screenshare,this.rtc.connType=t.connType,this.rtc.localVideo=n,this.rtc.remoteVideo=s,this.url=e||null,e&&($xirsys.api.iceUrl=e+"ice"),console.log("url "+e+" ice: "+$xirsys.api.iceUrl)},inherits:$xirsys.api,fields:{status:null,signal:null,xirsys_opts:{username:null,password:null,domain:null,application:null,room:null,automaticAnswer:!0},autoreply:null,rtc:{state:null,sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},useVideo:!0,useAudio:!0,useDataChannel:!0,dataChannelList:[],forceTurn:!1,screenshare:!1,connType:null,localStream:null,remoteStream:null,localVideo:null,remoteVideo:null,dataChannel:null,remoteDataChannel:null,peerConn:null,peer:null,ice:null,participant:null}},methods:{open:function(e,t){return this.signal&&!this.signal.isClosed&&this.close(),e?(this.xirsys_opts=e,this.autoreply=!!t,this.xirsys_opts.type="pub"==this.rtc.connType?"publish":"sub"==this.rtc.connType?"subscribe":null,this.signal=new $xirsys.signal,this.signal.onOpen=this.onSignalOpen.bind(this),this.signal.onClose=this.onSignalClose.bind(this),this.signal.onMessage=this.onSignalMessage.bind(this),this.signal.connect(this.xirsys_opts),this.signal):void this.error("connect","User credentials should be specified.")},close:function(){this.signal.close()},call:function(e){this.rtc.peer=e,this.rtc.participant=$xirsys.p2p.CLIENT,this.status=$xirsys.p2p.CALLING,this.setConstraints(),this.doPeerConnection(function(){var e={optional:[],mandatory:{MozDontOfferDataChannel:!this.rtc.useDataChannel}};if("chrome"===webrtcDetectedBrowser)for(var t in e.mandatory)t.indexOf("Moz")!=-1&&delete e.mandatory[t];if(e=this.mergeConstraints(e,this.rtc.sdpConstraints),this.rtc.useDataChannel){this.rtc.peerConn.ondatachannel=this.onRemoteDataChannel.bind(this);for(var n=0;n<this.rtc.dataChannelList.length;n++)this.doCreateDataChannel(this.rtc.dataChannelList[n])}this.rtc.peerConn.createOffer(this.setLocalAndSendMessage.bind(this),function(){},e)}.bind(this))},hangUp:function(){this.rtc.peerConn&&"closed"!=this.rtc.peerConn.signalingState&&this.rtc.peerConn.close()},answer:function(e){this.rtc.participant=$xirsys.p2p.PEER,!this.status==$xirsys.p2p.CALLING&&(this.status=$xirsys.p2p.ANSWERING),this.rtc.peer=e,this.setConstraints(),this.rtc.peerConn.createAnswer(this.setLocalAndSendMessage.bind(this),function(){})},doCreateDataChannel:function(e){e=e||"channelLabel",this.rtc.dataChannel=this.rtc.peerConn.createDataChannel(e,{}),this.rtc.dataChannel.onopen=function(e){"open"==this.rtc.dataChannel.onopen.readyState&&this.onDataChannelOpen()},this.rtc.dataChannel.onerror=this.onDataChannelError.bind(this),this.rtc.dataChannel.onmessage=this.onDataChannelMessage.bind(this),this.rtc.dataChannel.onopen=this.onDataChannelOpen.bind(this),this.rtc.dataChannel.onclose=this.onDataChannelClose.bind(this)},onRemoteDataChannel:function(e){this.rtc.remoteDataChannel=e.channel,this.rtc.remoteDataChannel.onmessage=this.onRemoteDataChannelMessage.bind(this)},onRemoteDataChannelMessage:function(e){$xirsys.events.getInstance().emit($xirsys.p2p.dataChannelMessage,e.data)},onDataChannel:function(e){var t=new xrtc.DataChannel(channelData.channel,remoteUser);dataChannels.push(t)},onDataChannelError:function(e){$xirsys.events.getInstance().emit($xirsys.p2p.dataChannelError,e)},onDataChannelMessage:function(e){$xirsys.events.getInstance().emit($xirsys.p2p.dataChannelMessage,e.data)},onDataChannelOpen:function(){$xirsys.events.getInstance().emit($xirsys.p2p.dataChannelOpen)},onDataChannelClose:function(){$xirsys.events.getInstance().emit($xirsys.p2p.dataChannelClose)},dataChannelSend:function(e){this.rtc.dataChannel.send(e)},dataChannelClose:function(){this.rtc.dataChannel.close()},onSignalOpen:function(){this.doGetUserMedia()},onSignalClose:function(){},onSignalMessage:function(e){switch(e.data.type){case"ice":this.status==$xirsys.p2p.CONNECTED?this.signal.send("session",{type:"denial",code:"user.insession"},e.peer):this.onIceServers(e.data.ice);break;case"offer":this.status==$xirsys.p2p.CONNECTED||(this.rtc.peerConn.setRemoteDescription(new RTCSessionDescription(e.data),function(){},function(){}),this.xirsys_opts.automaticAnswer===!0&&this.answer(e.peer,e.data),$xirsys.events.getInstance().emit($xirsys.p2p.offer,e.peer,e.data));break;case"answer":this.rtc.peerConn.setRemoteDescription(new RTCSessionDescription(e.data),function(){},function(){}),$xirsys.events.getInstance().emit($xirsys.p2p.answer);break;case"candidate":this.rtc.peerConn.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:e.data.label,candidate:e.data.candidate}));break;case"denial":$xirsys.events.getInstance().emit($xirsys.p2p.requestDenied,e.peer,{code:"user.insession"});break;default:$xirsys.events.getInstance().emit($xirsys.signal.message,e)}},onIceCandidate:function(e){if(e.candidate){var t=e.candidate.candidate.split(" ");this.rtc.forceTurn&&"relay"!=t[7]||this.signal.send("session",{type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate},this.rtc.peer,this.rtc.connType)}},onIceServers:function(e){this.rtc.ice=e;var t={optional:[{DtlsSrtpKeyAgreement:!0}]};this.rtc.useDataChannel&&t.optional.push({RtpDataChannels:!0});try{this.rtc.peerConn=new RTCPeerConnection(this.rtc.ice,t),this.rtc.useDataChannel&&(this.rtc.peerConn.ondatachannel=this.onRemoteDataChannel.bind(this)),this.rtc.peerConn.onicecandidate=this.onIceCandidate.bind(this),this.rtc.localStream&&this.rtc.peerConn.addStream(this.rtc.localStream),this.rtc.peerConn.onaddstream=this.onRemoteStreamAdded.bind(this),this.rtc.peerConn.oniceconnectionstatechange=this.onICEConnectionState.bind(this)}catch(e){this.rtc.onPeerConnectionError()}},onRemoteStreamAdded:function(e){this.rtc.remoteVideo&&(attachMediaStream(this.rtc.remoteVideo,e.stream),this.rtc.remoteStream=e.stream)},onICEConnectionState:function(e){"connected"!=e.target.iceGatheringState&&"complete"!=e.target.iceGatheringState||(this.status=$xirsys.p2p.CONNECTED,$xirsys.events.getInstance().emit($xirsys.p2p.iceConnected)),"disconnected"!=e.target.iceConnectionState&&"closed"!=e.target.iceConnectionState&&"failed"!=e.target.iceConnectionState||(this.status=$xirsys.p2p.DISCONNECTED,$xirsys.events.getInstance().emit($xirsys.p2p.iceDisconnected))},onUserMediaSuccess:function(e){this.rtc.localVideo&&this.rtc.useVideo&&(attachMediaStream(this.rtc.localVideo,e),this.rtc.localStream=e)},onUserMediaError:function(){this.error("doGetUserMedia","Could not get user media")},doPeerConnection:function(e){this.getIceServers(function(t){this.signal.send("session",{type:"ice",ice:t},this.rtc.peer,this.rtc.connType),this.onIceServers(t),e()}.bind(this))},onPeerConnectionError:function(){this.error("doPeerConnection","Could not create peer connection")},doGetUserMedia:function(){var e={audio:this.rtc.useAudio,video:{mandatory:{},optional:[]}};this.rtc.screenshare&&(e.video.mandatory={maxWidth:window.screen.width,maxHeight:window.screen.height,maxFrameRate:3},"chrome"===webrtcDetectedBrowser?e.video.mandatory.chromeMediaSource="screen":e.video.mandatory.mediaSource="screen",e.audio=!1);try{if(!this.rtc.useAudio&&!this.rtc.useVideo)return;getUserMedia(e,this.onUserMediaSuccess.bind(this),this.onUserMediaError.bind(this))}catch(e){this.onUserMediaError()}},setLocalAndSendMessage:function(e){this.rtc.peerConn.setLocalDescription(e),this.signal.send("session",e,this.rtc.peer,this.rtc.connType)},mergeConstraints:function(e,t){var n=e;for(var s in t.mandatory)n.mandatory[s]=t.mandatory[s];return n.optional.concat(t.optional),n},setConstraints:function(){this.rtc.sdpConstraints="{'mandatory': {'OfferToReceiveAudio':"+(!!this.rtc.useAudio).toString()+", 'OfferToReceiveVideo':"+(!!this.rtc.useVideo).toString()+" }}"},error:function(e,t){$xirsys.events.getInstance().emit($xirsys.p2p.error,e,t)}},statics:{PEER:"peer",CLIENT:"client",DISCONNECTED:"disconnected",CONNECTED:"connected",CALLING:"calling",ANSWERING:"answering",offer:"p2p.offer",answer:"p2p.answer",error:"p2p.error",iceConnected:"p2p.iceConnected",iceDisconnected:"p2p.iceDisconnected",dataChannelError:"p2p.dataChannelError",dataChannelMessage:"p2p.dataChannelMessage",dataChannelOpen:"p2p.dataChannelOpen",dataChannelClose:"p2p.dataChannelClose",requestDenied:"p2p.requestDenied",publish:"pub",subscribe:"sub",direct:null}})}(),function(){var e,t;t=$xirsys.class.create({namespace:"quickstart",inherits:$xirsys.ui,constructor:function(n,s){e=this,e.qs=t,e.events=$xirsys.events.getInstance();e.connectionData=$xirsys.extend({},n);e.server=s,e.secureTokenRetrieval=1==n.secure,window.onload=function(){t.parse(t.tag("body")[0],e.data),e.init()}},methods:{init:function(){this.p=new $xirsys.p2p(this.secureTokenRetrieval===!0?this.server:null,{audio:!0,video:!0},t.ref("local-video"),t.ref("remote-video")),t.ref("login").onsubmit=this.loginSubmitHandler.bind(e),t.ref("log-out").onclick=this.logoutClickHandler.bind(e),t.ref("sendMessage").onsubmit=this.sendMessageHandler.bind(e),t.ref("call-peer").onclick=this.callPeerHandler.bind(e),t.ref("hang-up").onclick=this.hangUpHandler.bind(e),t.ref("remote-full-screen").onclick=this.remoteFullScreenHandler.bind(e),t.ref("hideColumn").onclick=this.hideColumn.bind(e),t.ref("showColumn").onclick=this.showColumn.bind(e),t.ref("peers").onclick=this.doSelectPeer.bind(e),t.ref("chat-btn").onclick=this.doChat.bind(e),t.ref("remote-username").querySelectorAll("#hang-up")[0].onclick=this.hangUpHandler.bind(e),e.remotePeerName=document.querySelectorAll("#remote-username .title-text")[0],e.events.on($xirsys.signal.peers,function(t,n){for(var s=0;s<n.users.length;s++)e.addPeer(n.users[s])}),e.events.on($xirsys.signal.peerConnected,function(t,n){e.addPeer(n)}),e.events.on($xirsys.signal.peerRemoved,function(t,n){e.removePeer(n)}),e.events.on($xirsys.signal.message,function(t,n){n.sender!=e.username&&e.onMessage({sender:e.stripLeaf(n.sender),data:n.data})}),e.events.on($xirsys.p2p.offer,function(t,n,s){e.callIncoming(n,s)}),e.events.on($xirsys.signal.error,function(t,n){console.error("error: ",n),e.addMessage("ERROR",{internal:!0,type:"There has been an error in the server connection."})}),e.events.on($xirsys.p2p.iceDisconnected,function(t){e.callEnd(t)}),e.events.on($xirsys.p2p.requestDenied,function(t,n,s){console.log("requestDenied !!!!!"),e.callDenied(t,n,s)}),document.addEventListener("fullscreenchange",e.FShandler),document.addEventListener("webkitfullscreenchange",e.FShandler),document.addEventListener("mozfullscreenchange",e.FShandler),document.addEventListener("MSFullscreenChange",e.FShandler)},loginSubmitHandler:function(n){n.preventDefault(),e.username=t.ref("username").value.replace(/\W+/g,""),e.username&&""!==e.username&&(t.ref("login").parentNode.style.visibility="hidden",t.ref("log-out").style.visibility="visible",t.ref("log-out").className="sign-out-grn menu-icon-btns",e.connectionData.username=e.username,e.connectionData.automaticAnswer=e.automaticAnswer,e.p.open(e.connectionData))},logoutClickHandler:function(n){for(n.preventDefault(),e.username="";t.ref("username-label").hasChildNodes();)t.ref("username-label").removeChild(t.ref("username-label").lastChild);t.ref("username-label").appendChild(t.createText("User name")),t.ref("log-out").className="sign-out menu-icon-btns",t.ref("login").parentNode.style.visibility="visible",e.removeAllPeers(),void 0===e.remoteChatRequest&&e.callEnd(),detachMediaStream(t.ref("local-video")),e.p.close()},sendMessageHandler:function(n){if(n.preventDefault(),!e.p.signal)return void e.addMessage("INFO",{internal:!0,type:"msg-alert",message:"You are not yet logged into the chat."});var s=t.ref("message").value;0!=s.length&&(e.sendMsg(s,e.remoteChatRequest.peer),e.addMessage(e.username,s),t.ref("message").value="")},callPeerHandler:function(){if(e.remoteChatRequest.peer)return addMessage("ERROR",{internal:!0,type:"msg-alert",message:"Only a one-on-one peer conversation is currently allowed. Please end this call to chat with another user."}),void(e.chatOn||showChat(!0));var t=e.selectedPeer.call(e);t?(e.p.call(t),e.callStart(t)):e.addMessage("ERROR",{internal:!0,type:"msg-alert",message:"You must select a single peer before initiating a call."})},hangUpHandler:function(){e.callEnd()},localFullScreenHandler:function(n){e.fullScreenVideo(t.ref("local-video"))},remoteFullScreenHandler:function(n){e.fullScreenVideo(t.clsel("major-box")[0])},showColumn:function(e){e.target.style.display="none",t.clsel("vertical-bar")[0].style.display="unset"},hideColumn:function(e){t.clsel("vertical-bar")[0].style.display="none",t.ref("showColumn").style.display="unset"},addPeer:function(n){if(n==e.username){for(;t.ref("username-label").hasChildNodes();)t.ref("username-label").removeChild(t.ref("username-label").lastChild);t.ref("username-label").appendChild(t.createText(e.stripLeaf(n)))}else if(!t.ref("peer-"+n)){var s=t.createEl("div");s.className="user-icon-img peer-icon";var r=t.createEl("span");r.className="sr-only peer-label",r.textContent=e.stripLeaf(n);var i=t.createEl("div");i.appendChild(s),i.appendChild(r),i.id="peer-"+n,i.className="peer",t.ref("peers").appendChild(i)}},removePeer:function(n){var s=t.ref("peer-"+n),r=e.selectedPeer(!0);r&&r.id==s.id&&e.setSelectedPeer(r,!1),s&&t.ref("peers").removeChild(s)},removeAllPeers:function(){var e,n=t.tag("div",t.ref("peers")),s=n.length;for(e=0;e<s;e++){var r=n[e];r&&r.classList.contains("peer")&&t.ref("peers").removeChild(r)}},selectedPeer:function(e){for(var n=t.clsel("peer"),s=0,r=n.length;s<r;s++){var i=n[s];if(i.classList.contains("selected")){if("__all__"==i.id)return;return e?i:i.id.substr(5)}}},setSelectedPeer:function(n,s){void 0==s&&(s=!0);var r=e.selectedPeer(!0);if(r&&(r.classList.remove("selected"),r.id==n.id))return void(t.ref("call-peer").className="start-call menu-icon-btns");t.ref("call-peer").className="start-call-grn menu-icon-btns",n.classList.add("selected")},doSelectPeer:function(t){var n=t.target;n.classList.contains("peer")&&e.setSelectedPeer(n)},doChat:function(t){e.showChat(!e.chatOn)},onMessage:function(t){console.log("onMessage:",t.data);var n=e.remoteChatRequest.peer;n?t.sender==n&&e.addMessage(n,t.data):e.addMessage(t.sender,t.data)},sendMsg:function(t,n){e.p.signal.send("message",t,n?n:null)},addMessage:function(n,s){var r="chat-msg "+(n===e.username?"msg-user":"msg-peer");if("object"==typeof s){var i=s.type;if("action"===i){if(console.log("action:",s.code,"peer:",s.peer,"cur:",e.remoteChatRequest.peer),"rtc.p2p.close"===s.code&&e.remoteChatRequest.peer==s.peer)return void e.callEnd();if("rtc.p2p.deny"!==s.code||e.remoteChatRequest.peer!=s.peer)return;i="msg-alert",e.callEnd(null,!0)}s.from&&(n=s.from);var r="chat-msg "+i;s=s.message}var a=e.createMsgBox(n,s,r);t.ref("messages").appendChild(a),t.ref("messages").scrollTop=t.ref("messages").scrollHeight},createMsgBox:function(e,n,s){var r=new Date,i=r.getHours().toString(),a=r.getMinutes().toString(),o=(1==i.length?0+i:i)+":"+(1==a.length?0+a:a),c=t.createEl("span"),l=t.createEl("span"),d=t.createEl("div"),u=t.createEl("div"),h=t.createEl("div"),p=u.appendChild(c),m=u.appendChild(l);return c.innerHTML=e.toUpperCase()+": ",l.innerHTML=o,p.className="msg-from",m.className="msg-time",u.className="msg-header",d.innerHTML=n,h.appendChild(u),h.appendChild(d),s&&(h.className=s),h},stripLeaf:function(e){return void 0===e?"":e.substr(e.lastIndexOf("/")+1)},showChat:function(n){t.ref("chatHistory").style.display=n?"inherit":"none",t.ref("sendMessage").style.display=n?"inherit":"none",t.ref("chat-btn").style.backgroundColor=n?"#81b75c":"#797979",console.log("showChat",n,", display:",t.ref("chatHistory").style.display),e.chatOn=n,t.ref("messages").scrollTop=t.ref("messages").scrollHeight,e.chatOn&&e.isFullScreen()&&e.fullScreenVideo()},callIncoming:function(t,n){console.log("callIncoming",t,"  -  insession: ",!!e.remoteChatRequest.peer),console.log("callIncoming - auto answer:",e.automaticAnswer),e.automaticAnswer===!1?confirm("Take a call from "+t+"?")?(e.p.answer(t,n),e.callStart(t),e.addMessage("INFO",{internal:!0,type:"msg-info",message:"Taking a call from "+t})):(e.addMessage("INFO",{internal:!0,type:"msg-alert",message:"You rejected a call request from "+t+"."}),console.log("Denied Call: ",t),e.sendMsg({internal:!0,type:"action",code:"rtc.p2p.deny",peer:e.username,message:e.username+" denied your call request.",from:"INFO"},t)):(e.addMessage("INFO",{internal:!0,type:"msg-info",message:"Taking a call from "+t}),e.callStart(t))},fullScreenVideo:function(t){e.isFullScreen()?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen():t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.msRequestFullscreen&&t.msRequestFullscreen()},FShandler:function(){e.isFullScreen()?(t.ref("remote-full-screen").className="rounded-btn expand remote-fs-selected","none"!=t.ref("showColumn").style.display&&(t.ref("showColumn").style.visibility="hidden")):(t.ref("remote-full-screen").className="rounded-btn expand remote-fs-unselected","none"!=t.ref("showColumn").style.display&&(t.ref("showColumn").style.visibility="visible"))},isFullScreen:function(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)},callStart:function(n){e.remotePeerName.innerHTML=n,e.remoteChatRequest={peer:n},t.ref("hang-up").className="end-call-grn menu-icon-btns";var s=t.ref("peer-"+e.remoteChatRequest.peer);if(s){var r=s.getElementsByClassName("user-icon-img")[0];r&&(r.className="user-icon-img-grn peer-icon")}e.showChat(!1);var i=t.clsel("major-box")[0];i.classList.contains("hide-vid")&&i.classList.remove("hide-vid");var a=t.clsel("minor-box")[0];a.classList.contains("box-standby")&&a.classList.remove("box-standby"),t.ref("remote-video").style.visibility="visible",t.ref("remote-username").style.visibility="visible",t.ref("video-menu").style.visibility="visible",console.log("callStart:",e.remoteChatRequest)},callEnd:function(n,s){if(console.log("*** callEnd, peer:",e.remoteChatRequest.peer),e.remotePeerName.innerHTML="No Caller",t.ref("hang-up").className="end-call menu-icon-btns",e.p.hangUp(),void 0!==e.remoteChatRequest.peer){var r=t.ref("peer-"+e.remoteChatRequest.peer);if(r){var i=r.getElementsByClassName("user-icon-img-grn")[0];i&&(i.className="user-icon-img peer-icon")}e.showChat(!0);var a=t.clsel("major-box")[0];a.classList.contains("hide-vid")||a.classList.add("hide-vid");var o=t.clsel("minor-box")[0];o.classList.contains("box-standby")||o.classList.add("box-standby"),t.ref("remote-video").style.visibility="hidden",t.ref("remote-username").style.visibility="hidden",t.ref("video-menu").style.visibility="hidden",s===!1&&e.sendMsg({internal:!0,type:"action",code:"rtc.p2p.close",peer:e.username},e.remoteChatRequest.peer),e.remoteChatRequest={},e.isFullScreen()&&e.fullScreenVideo()}},callDenied:function(t,n,s){if("user.insession"===s.code){var r=e.remoteChatRequest.peer;e.callEnd(t,!0),e.addMessage("ERROR",{internal:!0,type:"msg-alert",message:r+"is currently in a session, please try again later."})}}},statics:{ref:function(e){return document.getElementById(e)},tag:function(e,t){return(t||document).getElementsByTagName(e)},elem:function(e){return document.getElementsByName(e)},clsel:function(e){return document.getElementsByClassName(e)},createEl:function(e){return document.createElement(e)},createText:function(e){return document.createTextNode(e)}},fields:{username:"",chatOn:!0,remoteChatRequest:{},automaticAnswer:!1,data:{type:"div",id:"xsdk-video-call",children:[{node:"section",class:"vertical-bar",children:[{id:"userInfo",children:[{node:"h1",class:"title-text",id:"username-label",children:["Username"]},{children:[{class:"box",id:"log-out",class:"menu-icon-btns sign-out",children:[{node:"text",children:["LOGOUT"]}]},{id:"call-peer",class:"menu-icon-btns start-call",children:[{node:"text",children:["CALL"]}]},{id:"hang-up",class:"menu-icon-btns end-call",children:[{node:"text",children:["HANG UP"]}]}]},{id:"hideColumn",class:"hide-btn"}]},{id:"peers"}]},{id:"right-pane",children:[{node:"section",class:"major-box fb-col-item hide-vid",children:[{node:"video",id:"remote-video",autoplay:"autoplay"},{node:"section",class:"minor-box box-standby",children:[{node:"video",id:"local-video",autoplay:"autoplay",muted:"true"}]},{id:"remote-username",children:[{id:"hang-up",class:"rounded-btn end-call-wt"},{node:"h1",class:"title-text",children:["No Caller"]}]},{id:"video-menu",children:[{id:"remote-full-screen",class:"rounded-btn expand remote-fs-unselected"},{id:"chat-btn",class:"rounded-btn chat-on"}]},{id:"co-logo",class:"brand-logo"},{id:"showColumn",class:"hide-btn"}]},{node:"section",id:"chatHistory",class:"horizontal-bar fb-col-item",children:[{id:"messages"}]},{node:"form",id:"sendMessage",class:"message",children:[{node:"input",type:"text",id:"message",autocomplete:"off",placeholder:"Enter chat text here"},{node:"button",id:"submit-btn",type:"submit"}]}]},{node:"section",class:"cover",children:[{node:"form",id:"login",children:[{node:"h1",id:"heading",children:["Welcome"]},{node:"input",type:"text",id:"username",placeholder:"Enter your name"},{node:"button",id:"login-btn",type:"submit",children:["CONNECT"]}]}]}]}}})}(),function(){$xirsys.class.create({namespace:"socket",constructor:function(e,t,n){this.url=e,this.httpUrl=t?t:e.replace("ws:","http:").replace("wss:","https:"),this.options=$xirsys.extend(this.options,n),this.openSocket()},fields:{isClosed:!0,readyState:3,url:"",httpUrl:"",options:{},transport:null,tn:0},methods:{xhrSend:function(e){if(this.readyState!=$xirsys.signal.CONNECTING&&this.readyState!=$xirsys.signal.OPEN)return!1;var t=this;return $xirsys.ajax.do({url:t.httpUrl,method:"POST",data:e,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8","X-Socket-Transport":"xhrPolling"}}).done(function(e){e&&0!==e.length&&t.onmessage({data:e})}),!0},websocket:function(){return(!this.options||!this.options.disableWebSocket)&&(window.WebSocket&&(this.transport=window.WebSocket),window.MozWebSocket&&navigator.userAgent.indexOf("Firefox/6.0")==-1&&(this.transport=window.MozWebSocket),this.transport?{heart:!0,transport:this.transport}:null)},eventPolling:function(){if(this.options&&this.options.disableEventSource)return!1
;if(!window.EventSource)return!1;var e=new window.EventSource(this.httpUrl);e.onopen=function(){t.readyState=$xirsys.signal.OPEN,t.onopen()},e.onmessage=function(e){t.onmessage(e)},e.onerror=function(){e.close(),e=void 0,t.onerror()};var t={readyState:$xirsys.signal.CONNECTING,send:this.xhrSend,close:function(){t.readyState=$xirsys.signal.CLOSED,e.close(),e=void 0,t.onclose()}};return{heart:!1,transport:function(){return t}}},xhrPolling:function(){if(this.options&&this.options.disableXHRPolling)return!1;var e=null,t={readyState:$xirsys.signal.CONNECTING,send:xhrSend,close:function(){this.readyState=$xirsys.signal.CLOSED,e&&(e.abort(),e=null),clearTimeout(void 0),t.onclose()},onopen:function(){},onmessage:function(){},onerror:function(){},onclose:function(){}};return self.nextPoll(),{heart:!1,transport:function(){return t}}},poll:function(){xhr=$xirsys.ajax.do({url:this.httpUrl,method:"GET",data:{},headers:{"X-Socket-Transport":"xhrPolling"}}).done(function(e){xhr=null,fake.readyState==$xirsys.signal.CONNECTING&&(fake.readyState=$xirsys.signal.OPEN,fake.onopen(fake)),e&&0!==e.length&&fake.onmessage({data:e}),fake.readyState==$xirsys.signal.OPEN&&this.nextPoll()}).fail(function(e){fake.onerror()})},nextPoll:function(){timeout=setTimeout(function(){this.poll()},100)},next:function(){var e=0,t={websocket:this.websocket,eventPolling:this.eventPolling,xhrPolling:this.xhrPolling};for(var n in t){if(this.tn==e){var s=t[n]();if(s){var r=new s.transport(this.url);return r.heart=s.heart,r}this.tn++}e++}return!1},openSocket:function(){function e(){if(n.isClosed=!1,n.readyState=$xirsys.signal.CONNECTING,n.transport=n.next(),!n.transport)return s=r,n.tn=0,n.ondisconnect(),setTimeout(function(){e()},i),!1;n.transport.onopen=function(){s=r,n.transport.heart&&(t=setInterval(function(){n.send("ping"),n.onheartbeat()},2e4)),n.readyState!=$xirsys.signal.OPEN&&(n.readyState=$xirsys.signal.OPEN,n.onopen())},n.transport.onclose=function(){n.isClosed||n.readyState==$xirsys.signal.CLOSED||(n.transport=null,clearInterval(t),n.readyState==$xirsys.signal.CLOSING?(n.readyState=$xirsys.signal.CLOSED,n.transport=!1,n.onclose()):(n.readyState==$xirsys.signal.CONNECTING&&n.tn++,s*=2,s>i&&(s=i),n.isClosed=!0,setTimeout(function(){e()},s)))},n.transport.onerror=function(e){n.onerror(e)},n.transport.onmessage=function(e){n.onmessage(e)}}var t,n=this,s=80,r=80,i=1e4;n.readyState=$xirsys.signal.CLOSED,n.isClosed=!0,e(),this.onopen=function(){},this.onmessage=function(){},this.ondisconnect=function(){},this.onclose=function(){},this.onheartbeat=function(){},this.onerror=function(){}},send:function(e){return!!this.transport&&this.transport.send(e)},close:function(){this.readyState=$xirsys.signal.CLOSING,this.transport&&this.transport.close()},setURL:function(e){this.url=e}},statics:{CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3}}),$xirsys.class.create({namespace:"signal",constructor:function(e){e&&(this.wsUrl=e+"?type=signal",this.tokenUrl=e+"?type=token")},inherits:$xirsys.socket,fields:{token:"",wsUrl:"",sock:null,xirsys_opts:null,room_key:""},methods:{connect:function(e){var t=this;this.xirsys_opts=e,t.getToken(null,null,function(e){t.getSocketEndpoints(function(n){t.sock=new $xirsys.socket(n+"/"+e),t.sock.onmessage=t.handleService.bind(t),t.sock.onopen=t.onOpen.bind(t),t.sock.ondisconnect=t.onDisconnect.bind(t),t.sock.onclose=t.onClose.bind(t),t.sock.onerror=t.onError.bind(t)})})},close:function(){this.sock.close()},send:function(e,t,n,s){var r={t:"u",m:{f:this.xirsys_opts.channel+"/"+this.xirsys_opts.username,t:n,o:e},p:t};!s||"pub"!=s&&"sub"!=s||(r.t="tm",r.m.o=s);var i=JSON.stringify(r);this.sock.send(i)},handleService:function(e){var t=JSON.parse(e.data);switch(t.t||this.onError({message:"invalid message received",data:t}),t.t){case"u":this.handleUserService(t);break;default:console.log("don't know this packet type "+t.t)}},handleUserService:function(e){var t=null;switch(e.m.f&&(t=e.m.f.split("/"),t=t[t.length-1]),e.m.o){case"peers":this.onPeers(e.p);break;case"peer_connected":this.onPeerConnected(t);break;case"peer_removed":this.onPeerRemoved(t);break;default:this.onMessage({type:e.m.o,sender:t,data:e.p,peer:t})}},getToken:function(e,t,n){console.log("Datat is ",t);var s=this,r=t||s.xirsys_opts;console.log("opts?",r),$xirsys.ajax.do({url:e||this.tokenUrl||$xirsys.signal.tokenUrl(r.channel,r.username),headers:$xirsys.authHeader(r),method:"PUT",data:JSON.stringify({})}).done(function(e){if(e.e)return void s.onError(e.e);s.token=e.v,n.apply(this,[s.token])})},getSocketEndpoints:function(e){var t=this,n=t.xirsys_opts;$xirsys.ajax.do({url:this.wsUrl||$xirsys.signal.wsList,headers:$xirsys.authHeader(n),method:"GET",data:{}}).done(function(n){if(n.e)return void t.onError(n.e);t.wsUrl=n.v+"/v1",e.apply(this,[t.wsUrl])})},onOpen:function(){$xirsys.events.getInstance().emit($xirsys.signal.open)},onPeers:function(e){$xirsys.events.getInstance().emit($xirsys.signal.peers,e)},onPeerConnected:function(e){$xirsys.events.getInstance().emit($xirsys.signal.peerConnected,e)},onPeerRemoved:function(e){$xirsys.events.getInstance().emit($xirsys.signal.peerRemoved,e)},onMessage:function(e){$xirsys.events.getInstance().emit($xirsys.signal.message,e)},onDisconnect:function(){$xirsys.events.getInstance().emit($xirsys.signal.disconnected)},onClose:function(){$xirsys.events.getInstance().emit($xirsys.signal.closed)},onError:function(e){$xirsys.events.getInstance().emit($xirsys.signal.error,e)}},statics:{wsList:$xirsys.url("_host",{type:"signal"}),tokenUrl:function(e,t){return $xirsys.url("_token/"+e,{k:t})},open:"signalling.open",peers:"signalling.peers",peerConnected:"signalling.peer.connected",peerRemoved:"signalling.peer.removed",message:"signalling.message",disconnected:"signalling.disconnected",closed:"signalling.closed",error:"signalling.error"}})}(),function(){var e=$xirsys.class.create({namespace:"connection",inherits:$xirsys.signal,constructor:function(t,n,s){console.log(n),e.Super.constructor.call(this,n),this.inst=t,this.opts=s||{},this.opts.secure=s.secure||1,this.peers={}},methods:{disconnect:function(){this.close()},emit:function(e,t,n){switch(e){case"message":t.to?this.send(e,t,t.to,t.type):this.send(e,t);break;case"create":this.createRoom(t,n);break;case"join":this.joinRoom(t,n);break;case"leave":this.disconnect();break;default:this.send(e,t)}},on:function(e,t){$xirsys.events.getInstance().on(e,t)},getSessionid:function(){return this.sessionId=this.sessionId||this.xirsys_opts&&this.xirsys_opts.username||(new Date).getTime(),this.sessionId},createRoom:function(e,t){var n=this,s=$xirsys.simplewebrtc.roomUrl;"string"!=typeof s&&(s=s(e)),this.inst.xirsysRequest(s,function(s){n.inst.xirsysRequest($xirsys.simplewebrtc.iceUrl,function(r){if("error"==r.s)return void console.error("Could not get ICE string",r.v);n.setupRoom(e,r.v.iceServers),t.apply(n,["error"==s.s&&"path_exists"!=s.v?s.v:null,e])},n.xirsys_opts)},n.xirsys_opts)},joinRoom:function(e,t){var n=this;this.inst.xirsysRequest($xirsys.simplewebrtc.iceUrl,function(s){if("error"==s.s)return void console.error("Could not get ICE string",s.v);n.setupRoom(e,s.v.iceServers),n.joinCB=t},n.xirsys_opts)},setupRoom:function(e,t){this.opts.room=e,this.opts.username=this.opts.username||this.getSessionid(),this.peers={},this.connect(this.opts);var n=t.filter(function(e){return e.url.startsWith("stun")}),s=t.filter(function(e){return e.url.startsWith("turn")});$xirsys.events.getInstance().emit("stunservers",n),$xirsys.events.getInstance().emit("turnservers",s)},getIceServers:function(){this.inst.xirsysRequest($xirsys.simplewebrtc.iceUrl,function(e){for(var t=e.v.iceServers,n=t.length,s=[],r=[],i=0;i<n;i++)t[i].url.startsWith("stun")?s.push(t[i]):r.push(t[i]);$xirsys.events.getInstance().emit("stunservers",s),setInterval(function(){$xirsys.events.getInstance().emit("turnservers",r)},50)},self.xirsys_opts)},addPeer:function(e){if(e!=this.opts.username){for(var t in this.peers)if(t==e)return;this.peers[e]={type:"video"}}},removePeer:function(e){for(var t in this.peers)if(t==e)return void(this.peers[t]=null)},onMessage:function(t){e.Super.onMessage.call(),$xirsys.events.getInstance().emit(t.type,t.data)},onOpen:function(){e.Super.onOpen.call(),$xirsys.events.getInstance().emit("open")},onPeers:function(t){e.Super.onPeers.call(this,t);for(var n=0,s=t.users.length;n<s;n++)this.addPeer(t.users[n]);this.joinCB&&this.joinCB.apply(this,[null,{clients:this.peers}])},onPeerConnected:function(t){e.Super.onPeerConnected.call(this,t),this.addPeer(t)},onPeerRemoved:function(t){e.Super.onPeerRemoved.call(this,t),$xirsys.events.getInstance().emit("remove",t)}}})}(),function(){$xirsys.class.create({namespace:"simplewebrtc",constructor:function(e){var t=$xirsys.simplewebrtc;e&&(t.tokenUrl=e+"?type=token",t.iceUrl=e+"?type=ice",t.roomUrl=e+"?type=room",t.wsUrl=e+"?type=signal")},fields:{connectionTypes:{default:"default",direct:"direct",server:"server"},token:"",ice:[],xirsys_opts:null},methods:{connect:function(e,t,n){this.xirsys_opts=e,t=t||{};var s=this;s.xirsysRequest($xirsys.simplewebrtc.wsUrl,function(r){s.ws=r.v,t.url="ws"+s.ws.substr(2,s.ws.length),t.connection=new $xirsys.connection(s,null,e),s.ref=new SimpleWebRTC(t),n.apply(s,s.ref)})},on:function(e,t){this.ref.on(e,t)},getDomId:function(e){return this.ref.getDomId(e)},capabilities:function(){return this.ref.capabilities},createRoom:function(e,t){var n=this;e&&(this.xirsys_opts.room=e),n.ref.createRoom(e,t)},prepareRoom:function(e){e&&(this.prepare_room=e,this.ref.sessionReady=!0)},joinRoom:function(e){var t=this;e&&(this.xirsys_opts.channel=e),t.ref.joinRoom(e)},leaveRoom:function(){this.ref.leaveRoom()},xirsysRequest:function(e,t,n){var s=this.xirsys_opts;$xirsys.ajax.do({url:e,method:"PUT",headers:$xirsys.authHeader(s),data:n}).done(t)},getLocalScreen:function(){return this.ref.getLocalScreen()},stopScreenShare:function(){this.ref.stopScreenShare()},shareScreen:function(e){this.ref.shareScreen(e)}},statics:{tokenUrl:function(e,t){return $xirsys.url("_token/"+e,{k:t})},iceUrl:$xirsys.url("_turn"),wsUrl:$xirsys.url("_host",{type:"signal"}),roomUrl:function(e){return $xirsys.url("_ns/"+e)}}})}(),function(){var e=$xirsys.class.create({namespace:"ui",statics:{parse:function(t,n){var s=e.buildNode(t,n);s&&n.children&&n.children.constructor==Array&&n.children.forEach(function(t){e.parse(s,t)})},buildNode:function(e,t){if("string"==typeof t)return e.append(document.createTextNode(t)),null;var n=document.createElement(t.node||"div");return Object.keys(t).filter(function(e){return"node"!=e&&"children"!=e&&t.hasOwnProperty(e)}).map(function(e){n.setAttribute(e,t[e])}),e.append(n),n}}})}();