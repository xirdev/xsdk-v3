var $xirsys={class:{},baseUrl:"ws.xirsys.com"};!function(){$xirsys.extend=function(e,t){for(var n in t)"object"==typeof t[n]&&null!==t[n]?(e[n]=e[n]||{},arguments.callee(e[n],t[n])):e[n]=t[n];return e},$xirsys.url=function(e,t){var n=t?"?"+$xirsys.parseParams(t):"";return"https://"+$xirsys.baseUrl+"/"+e+n},$xirsys.parseParams=function(e){var t=[];for(var n in e)t.push(n+"="+e[n]);return t.join("&")},$xirsys.authHeader=function(e){return{Authorization:"Basic "+btoa(e.ident+":"+e.secret)}},$xirsys.isArray=function(e){return!!e&&e.constructor==Array},$xirsys.isString=function(e){return"string"==typeof e},$xirsys.class.create=function(e){var t,n,s,i,r,o=[],a=function(){},c={},l={},h={},d=$xirsys,u=Object.prototype.hasOwnProperty;if(!e)return function(){};if(!(n=e.namespace))throw new Error("Please specify the Namespace.");if(0==n.length||n.indexOf(" ")!=-1||"."==n.charAt(0)||"."==n.charAt(n.length-1)||n.indexOf("..")!=-1)throw new Error("Illegal Namespace: "+n);for(o=n.split("."),t=0;t<o.length;t++)d&&(d=d[o[t]]);if(d)return d;if(u.call(e,"constructor")){if("function"!=typeof e.constructor)throw new TypeError("Illegal function ["+n+".constructor]!");a=e.constructor}for(e.inherits&&(this.inherits=function(e,t){for(s in t)u.call(t,s)&&(e[s]=t[s]);c=function(){this.constructor=e},c.prototype=t.prototype,e.prototype=new c,e.__super__=e.Super=t.prototype,s=t=c=e=null},this.inherits(a,e.inherits)),l=function(e,t,n){for(s in t)u.call(t,s)&&(n?e[s]=t[s]:e.prototype[s]=t[s])},e.methods&&l(a,e.methods),e.fields||(e.fields={}),e.fields.className=n,l(a,e.fields),e.statics&&l(a,e.statics,!0),e.props&&(h=a.prototype.props=$.extend(!0,{},a.prototype.props),l(h,$.extend(!0,{},e.props),!0)),d=$xirsys,t=0;t<o.length-1;t++){if(i=o[t],d[i]){if("object"!=typeof d[i])throw r=o.slice(0,t).join("."),new Error(r+" already exists and is not an object")}else d[i]={};d=d[i]}return d[o[o.length-1]]=a,n=o=u=d=l=t=null,a},$xirsys.class.create({namespace:"ajax",fields:{host:{},xhr:null},methods:{request:function(e){return"string"==typeof e&&(e={url:e}),e.url=e.url||"",e.method=e.method||"get",e.data=e.data||{},this.process(e)},getParams:function(e,t){var n,s=[];for(var i in e)s.push(i+"="+encodeURIComponent(e[i]));return n=s.join("&"),""!=n?t?t.indexOf("?")<0?"?"+n:"&"+n:n:""},extend:$xirsys.extend,done:function(e){return this.doneCallback=e,this},fail:function(e){return this.failCallback=e,this},always:function(e){return this.alwaysCallback=e,this},setHeaders:function(e){for(var t in e)this.xhr&&this.xhr.setRequestHeader(t,e[t])},process:function(e){var t=this;return window.ActiveXObject?this.xhr=new ActiveXObject("Microsoft.XMLHTTP"):window.XMLHttpRequest&&(this.xhr=new XMLHttpRequest),this.xhr&&(this.xhr.onreadystatechange=function(){if(4==t.xhr.readyState&&t.xhr.status>=200&&t.xhr.status<300){var n=t.xhr.responseText;e.json&&e.json!==!0||"undefined"==typeof JSON||(n=JSON.parse(n)),t.doneCallback&&t.doneCallback.apply(t.host,[n,t.xhr])}else 4==t.xhr.readyState&&t.failCallback&&t.failCallback.apply(t.host,[t.xhr]);t.alwaysCallback&&t.alwaysCallback.apply(t.host,[t.xhr])}),"get"==e.method.toLowerCase()?this.xhr.open("GET",e.url+t.getParams(e.data,e.url),!0):(this.xhr.open(e.method,e.url,!0),console.log("SETTEING HEADERS for ",e.method),this.setHeaders({"X-Requested-With":"XMLHttpRequest","Content-type":"application/json"})),e.headers&&"object"==typeof e.headers&&this.setHeaders(e.headers),setTimeout(function(){"get"==e.method?t.xhr.send():t.xhr.send(e.data)},20),this}},statics:{inst:null,do:function(e){return(new $xirsys.ajax).request(e)}}}),$xirsys.class.create({namespace:"events",fields:{delimiter:".",wildcard:"*",_stack:{}},methods:{on:function(e,t){var n=$xirsys.events.getInstance()._getNamespaceSegment(e);this.has(e,t)||n._handlers.push(t)},remove:function(e,t){var n=$xirsys.events.getInstance()._getNamespaceSegment(e);n._handlers=n._handlers||[];for(var s=0;s<n._handlers.length;s++)if(n._handlers[s]==t||t===-1)return void n._handlers.splice(s)},flush:function(e){if($xirsys.isArray(e))for(var t=0;t<e.length;t++)e[t]&&this.removeAllListeners(e[t]);else e[t]&&this.removeListener(e[t],-1)},has:function(e,t){if(!t||"function"!=typeof t)throw"Event handler must be supplied as a function";var n=$xirsys.events.getInstance()._getNamespaceSegment(e);n._handlers||(n._handlers=[]);for(var s=!1,i=0;i<n._handlers.length;i++)n._handlers[i]==t&&(s=!0);return s},emit:function(e){for(var t=$xirsys.events.getInstance()._getNamespaceSegment(e,!0),n=Array.prototype.slice.call(arguments,0),s=0;s<t.length;s++)for(var i=0;i<t[s]._handlers.length;i++)t[s]._handlers[i].apply(this,n)},_getNamespaceSegment:function(e,t,n){var s=$xirsys.isString(e)?e.split(this.delimiter):$xirsys.isArray(e)?e:null;if(!s)throw"Event listener assigned to unknown type";for(var i=this._stack,r=0;r<s.length;r++){if(!$xirsys.isString(s[r]))throw"Event identifier segment not a string value";if("_handlers"==s[r]||s[r]==this.wildcard&&r<s.length-1)throw"Invalid name used in event namespace.";i=i[s[r]]=i[s[r]]||{}}return i._handlers=i._handlers||[],t?(n&&$xirsys.isArray(n)||(n=[]),n.push(i),s[s.length-1]==this.wildcard&&s.pop(),s.length>0&&(s.pop(),s.push(this.wildcard),this._getNamespaceSegment(s,t,n)),n):i}},statics:{_instance:null,getInstance:function(){return $xirsys.events._instance=$xirsys.events._instance||new $xirsys.events}}})}(),function(){$xirsys.class.create({namespace:"api",constructor:function(e,t){t&&(this.url=t+"?type=ice"),this.data=e},fields:{ice:null},methods:{getIceServers:function(e){var t=this,n=t.xirsys_opts;console.log("TURN OPTS ARE",n),$xirsys.ajax.do({url:(this.url||$xirsys.api.iceUrl)+"/"+n.channel,headers:$xirsys.authHeader(n),method:"PUT",data:JSON.stringify({})}).done(function(n){t.ice=n.v,e.apply(this,[t.ice])})}},statics:{iceUrl:$xirsys.url("_turn")}})}(),function(){$xirsys.class.create({namespace:"socket",constructor:function(e,t,n){this.url=e,this.httpUrl=t?t:e.replace("ws:","http:").replace("wss:","https:"),this.options=$xirsys.extend(this.options,n),this.openSocket()},fields:{isClosed:!0,readyState:3,url:"",httpUrl:"",options:{},transport:null,tn:0},methods:{xhrSend:function(e){if(this.readyState!=$xirsys.signal.CONNECTING&&this.readyState!=$xirsys.signal.OPEN)return!1;var t=this;return $xirsys.ajax.do({url:t.httpUrl,method:"POST",data:e,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8","X-Socket-Transport":"xhrPolling"}}).done(function(e){e&&0!==e.length&&t.onmessage({data:e})}),!0},websocket:function(){return(!this.options||!this.options.disableWebSocket)&&(window.WebSocket&&(this.transport=window.WebSocket),window.MozWebSocket&&navigator.userAgent.indexOf("Firefox/6.0")==-1&&(this.transport=window.MozWebSocket),this.transport?{heart:!0,transport:this.transport}:null)},eventPolling:function(){if(this.options&&this.options.disableEventSource)return!1;if(!window.EventSource)return!1;var e=new window.EventSource(this.httpUrl);e.onopen=function(){t.readyState=$xirsys.signal.OPEN,t.onopen()},e.onmessage=function(e){t.onmessage(e)},e.onerror=function(){e.close(),e=void 0,t.onerror()};var t={readyState:$xirsys.signal.CONNECTING,send:this.xhrSend,close:function(){t.readyState=$xirsys.signal.CLOSED,e.close(),e=void 0,t.onclose()}};return{heart:!1,transport:function(){return t}}},xhrPolling:function(){if(this.options&&this.options.disableXHRPolling)return!1;var e=null,t={readyState:$xirsys.signal.CONNECTING,send:xhrSend,close:function(){this.readyState=$xirsys.signal.CLOSED,e&&(e.abort(),e=null),clearTimeout(void 0),t.onclose()},onopen:function(){},onmessage:function(){},onerror:function(){},onclose:function(){}};return self.nextPoll(),{heart:!1,transport:function(){return t}}},poll:function(){xhr=$xirsys.ajax.do({url:this.httpUrl,method:"GET",data:{},headers:{"X-Socket-Transport":"xhrPolling"}}).done(function(e){xhr=null,fake.readyState==$xirsys.signal.CONNECTING&&(fake.readyState=$xirsys.signal.OPEN,fake.onopen(fake)),e&&0!==e.length&&fake.onmessage({data:e}),fake.readyState==$xirsys.signal.OPEN&&this.nextPoll()}).fail(function(e){fake.onerror()})},nextPoll:function(){timeout=setTimeout(function(){this.poll()},100)},next:function(){var e=0,t={websocket:this.websocket,eventPolling:this.eventPolling,xhrPolling:this.xhrPolling};for(var n in t){if(this.tn==e){var s=t[n]();if(s){var i=new s.transport(this.url);return i.heart=s.heart,i}this.tn++}e++}return!1},openSocket:function(){function e(){if(n.isClosed=!1,n.readyState=$xirsys.signal.CONNECTING,n.transport=n.next(),!n.transport)return s=i,n.tn=0,n.ondisconnect(),setTimeout(function(){e()},r),!1;n.transport.onopen=function(){s=i,n.transport.heart&&(t=setInterval(function(){n.send("ping"),n.onheartbeat()},2e4)),n.readyState!=$xirsys.signal.OPEN&&(n.readyState=$xirsys.signal.OPEN,n.onopen())},n.transport.onclose=function(){n.isClosed||n.readyState==$xirsys.signal.CLOSED||(n.transport=null,clearInterval(t),n.readyState==$xirsys.signal.CLOSING?(n.readyState=$xirsys.signal.CLOSED,n.transport=!1,n.onclose()):(n.readyState==$xirsys.signal.CONNECTING&&n.tn++,s*=2,s>r&&(s=r),n.isClosed=!0,setTimeout(function(){e()},s)))},n.transport.onerror=function(e){n.onerror(e)},n.transport.onmessage=function(e){n.onmessage(e)}}var t,n=this,s=80,i=80,r=1e4;n.readyState=$xirsys.signal.CLOSED,n.isClosed=!0,e(),this.onopen=function(){},this.onmessage=function(){},this.ondisconnect=function(){},this.onclose=function(){},this.onheartbeat=function(){},this.onerror=function(){}},send:function(e){return!!this.transport&&this.transport.send(e)},close:function(){this.readyState=$xirsys.signal.CLOSING,this.transport&&this.transport.close()},setURL:function(e){this.url=e}},statics:{CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3}}),$xirsys.class.create({namespace:"signal",constructor:function(e){e&&(this.wsUrl=e+"?type=signal",this.tokenUrl=e+"?type=token")},inherits:$xirsys.socket,fields:{token:"",wsUrl:"",sock:null,xirsys_opts:null,room_key:""},methods:{connect:function(e){var t=this;this.xirsys_opts=e,t.getToken(null,null,function(e){t.getSocketEndpoints(function(n){t.sock=new $xirsys.socket(n+"/"+e),t.sock.onmessage=t.handleService.bind(t),t.sock.onopen=t.onOpen.bind(t),t.sock.ondisconnect=t.onDisconnect.bind(t),t.sock.onclose=t.onClose.bind(t),t.sock.onerror=t.onError.bind(t)})})},close:function(){this.sock.close()},send:function(e,t,n,s){var i={t:"u",m:{f:this.xirsys_opts.channel+"/"+this.xirsys_opts.username,t:n,o:e},p:t};!s||"pub"!=s&&"sub"!=s||(i.t="tm",i.m.o=s);var r=JSON.stringify(i);this.sock.send(r)},handleService:function(e){var t=JSON.parse(e.data);switch(t.t||this.onError({message:"invalid message received",data:t}),t.t){case"u":this.handleUserService(t);break;default:console.log("don't know this packet type "+t.t)}},handleUserService:function(e){var t=null;switch(e.m.f&&(t=e.m.f.split("/"),t=t[t.length-1]),e.m.o){case"peers":this.onPeers(e.p);break;case"peer_connected":this.onPeerConnected(t);break;case"peer_removed":this.onPeerRemoved(t);break;default:this.onMessage({type:e.m.o,sender:t,data:e.p,peer:t})}},getToken:function(e,t,n){console.log("Datat is ",t);var s=this,i=t||s.xirsys_opts;console.log("opts?",i),$xirsys.ajax.do({url:e||this.tokenUrl||$xirsys.signal.tokenUrl(i.channel,i.username),headers:$xirsys.authHeader(i),method:"PUT",data:JSON.stringify({})}).done(function(e){if(e.e)return void s.onError(e.e);s.token=e.v,n.apply(this,[s.token])})},getSocketEndpoints:function(e){var t=this,n=t.xirsys_opts;$xirsys.ajax.do({url:this.wsUrl||$xirsys.signal.wsList,headers:$xirsys.authHeader(n),method:"GET",data:{}}).done(function(n){if(n.e)return void t.onError(n.e);t.wsUrl=n.v+"/v1",e.apply(this,[t.wsUrl])})},onOpen:function(){$xirsys.events.getInstance().emit($xirsys.signal.open)},onPeers:function(e){$xirsys.events.getInstance().emit($xirsys.signal.peers,e)},onPeerConnected:function(e){$xirsys.events.getInstance().emit($xirsys.signal.peerConnected,e)},onPeerRemoved:function(e){$xirsys.events.getInstance().emit($xirsys.signal.peerRemoved,e)},onMessage:function(e){$xirsys.events.getInstance().emit($xirsys.signal.message,e)},onDisconnect:function(){$xirsys.events.getInstance().emit($xirsys.signal.disconnected)},onClose:function(){$xirsys.events.getInstance().emit($xirsys.signal.closed)},onError:function(e){$xirsys.events.getInstance().emit($xirsys.signal.error,e)}},statics:{wsList:$xirsys.url("_host",{type:"signal"}),tokenUrl:function(e,t){return $xirsys.url("_token/"+e,{k:t})},open:"signalling.open",peers:"signalling.peers",peerConnected:"signalling.peer.connected",peerRemoved:"signalling.peer.removed",message:"signalling.message",disconnected:"signalling.disconnected",closed:"signalling.closed",error:"signalling.error"}})}(),function(){$xirsys.class.create({namespace:"p2p",constructor:function(e,t,n,s){this.status=$xirsys.p2p.DISCONNECTED,void 0!==t.video&&(this.rtc.useVideo=!!t.video),void 0!==t.audio&&(this.rtc.useAudio=!!t.audio),this.rtc.useDataChannel=!!t.dataChannels,this.rtc.useDataChannel&&(this.rtc.dataChannelList=t.dataChannels),this.rtc.forceTurn=!!t.forceTurn,this.rtc.screenshare=!!t.screenshare,this.rtc.connType=t.connType,this.rtc.localVideo=n,this.rtc.remoteVideo=s,this.url=e||null,e&&($xirsys.api.iceUrl=e+"ice"),console.log("url "+e+" ice: "+$xirsys.api.iceUrl)},inherits:$xirsys.api,fields:{status:null,signal:null,xirsys_opts:{username:null,password:null,domain:null,application:null,room:null,automaticAnswer:!0},autoreply:null,rtc:{state:null,sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},useVideo:!0,useAudio:!0,useDataChannel:!0,dataChannelList:[],forceTurn:!1,screenshare:!1,connType:null,localStream:null,remoteStream:null,localVideo:null,remoteVideo:null,dataChannel:null,remoteDataChannel:null,peerConn:null,peer:null,ice:null,participant:null}},methods:{open:function(e,t){return this.signal&&!this.signal.isClosed&&this.close(),e?(this.xirsys_opts=e,this.autoreply=!!t,this.xirsys_opts.type="pub"==this.rtc.connType?"publish":"sub"==this.rtc.connType?"subscribe":null,this.signal=new $xirsys.signal,this.signal.onOpen=this.onSignalOpen.bind(this),this.signal.onClose=this.onSignalClose.bind(this),this.signal.onMessage=this.onSignalMessage.bind(this),this.signal.connect(this.xirsys_opts),this.signal):void this.error("connect","User credentials should be specified.")},close:function(){this.signal.close()},call:function(e){this.rtc.peer=e,this.rtc.participant=$xirsys.p2p.CLIENT,this.status=$xirsys.p2p.CALLING,this.setConstraints(),this.doPeerConnection(function(){var e={optional:[],mandatory:{MozDontOfferDataChannel:!this.rtc.useDataChannel}};if("chrome"===webrtcDetectedBrowser)for(var t in e.mandatory)t.indexOf("Moz")!=-1&&delete e.mandatory[t];if(e=this.mergeConstraints(e,this.rtc.sdpConstraints),this.rtc.useDataChannel){this.rtc.peerConn.ondatachannel=this.onRemoteDataChannel.bind(this);for(var n=0;n<this.rtc.dataChannelList.length;n++)this.doCreateDataChannel(this.rtc.dataChannelList[n])}this.rtc.peerConn.createOffer(this.setLocalAndSendMessage.bind(this),function(){},e)}.bind(this))},hangUp:function(){this.rtc.peerConn&&"closed"!=this.rtc.peerConn.signalingState&&this.rtc.peerConn.close()},answer:function(e){this.rtc.participant=$xirsys.p2p.PEER,!this.status==$xirsys.p2p.CALLING&&(this.status=$xirsys.p2p.ANSWERING),this.rtc.peer=e,this.setConstraints(),this.rtc.peerConn.createAnswer(this.setLocalAndSendMessage.bind(this),function(){})},doCreateDataChannel:function(e){e=e||"channelLabel",this.rtc.dataChannel=this.rtc.peerConn.createDataChannel(e,{}),this.rtc.dataChannel.onopen=function(e){"open"==this.rtc.dataChannel.onopen.readyState&&this.onDataChannelOpen()},this.rtc.dataChannel.onerror=this.onDataChannelError.bind(this),this.rtc.dataChannel.onmessage=this.onDataChannelMessage.bind(this),this.rtc.dataChannel.onopen=this.onDataChannelOpen.bind(this),this.rtc.dataChannel.onclose=this.onDataChannelClose.bind(this)},onRemoteDataChannel:function(e){this.rtc.remoteDataChannel=e.channel,this.rtc.remoteDataChannel.onmessage=this.onRemoteDataChannelMessage.bind(this)},onRemoteDataChannelMessage:function(e){$xirsys.events.getInstance().emit($xirsys.p2p.dataChannelMessage,e.data)},onDataChannel:function(e){var t=new xrtc.DataChannel(channelData.channel,remoteUser);dataChannels.push(t)},onDataChannelError:function(e){$xirsys.events.getInstance().emit($xirsys.p2p.dataChannelError,e)},onDataChannelMessage:function(e){$xirsys.events.getInstance().emit($xirsys.p2p.dataChannelMessage,e.data)},onDataChannelOpen:function(){$xirsys.events.getInstance().emit($xirsys.p2p.dataChannelOpen)},onDataChannelClose:function(){$xirsys.events.getInstance().emit($xirsys.p2p.dataChannelClose)},dataChannelSend:function(e){this.rtc.dataChannel.send(e)},dataChannelClose:function(){this.rtc.dataChannel.close()},onSignalOpen:function(){this.doGetUserMedia()},onSignalClose:function(){},onSignalMessage:function(e){switch(e.data.type){case"ice":this.status==$xirsys.p2p.CONNECTED?this.signal.send("session",{type:"denial",code:"user.insession"},e.peer):this.onIceServers(e.data.ice);break;case"offer":this.status==$xirsys.p2p.CONNECTED||(this.rtc.peerConn.setRemoteDescription(new RTCSessionDescription(e.data),function(){},function(){}),this.xirsys_opts.automaticAnswer===!0&&this.answer(e.peer,e.data),$xirsys.events.getInstance().emit($xirsys.p2p.offer,e.peer,e.data));break;case"answer":this.rtc.peerConn.setRemoteDescription(new RTCSessionDescription(e.data),function(){},function(){}),$xirsys.events.getInstance().emit($xirsys.p2p.answer);break;case"candidate":this.rtc.peerConn.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:e.data.label,candidate:e.data.candidate}));break;case"denial":$xirsys.events.getInstance().emit($xirsys.p2p.requestDenied,e.peer,{code:"user.insession"});break;default:$xirsys.events.getInstance().emit($xirsys.signal.message,e)}},onIceCandidate:function(e){if(e.candidate){var t=e.candidate.candidate.split(" ");this.rtc.forceTurn&&"relay"!=t[7]||this.signal.send("session",{type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate},this.rtc.peer,this.rtc.connType)}},onIceServers:function(e){this.rtc.ice=e;var t={optional:[{DtlsSrtpKeyAgreement:!0}]};this.rtc.useDataChannel&&t.optional.push({RtpDataChannels:!0});try{this.rtc.peerConn=new RTCPeerConnection(this.rtc.ice,t),this.rtc.useDataChannel&&(this.rtc.peerConn.ondatachannel=this.onRemoteDataChannel.bind(this)),this.rtc.peerConn.onicecandidate=this.onIceCandidate.bind(this),this.rtc.localStream&&this.rtc.peerConn.addStream(this.rtc.localStream),this.rtc.peerConn.onaddstream=this.onRemoteStreamAdded.bind(this),this.rtc.peerConn.oniceconnectionstatechange=this.onICEConnectionState.bind(this)}catch(e){this.rtc.onPeerConnectionError()}},onRemoteStreamAdded:function(e){this.rtc.remoteVideo&&(attachMediaStream(this.rtc.remoteVideo,e.stream),this.rtc.remoteStream=e.stream)},onICEConnectionState:function(e){"connected"!=e.target.iceGatheringState&&"complete"!=e.target.iceGatheringState||(this.status=$xirsys.p2p.CONNECTED,$xirsys.events.getInstance().emit($xirsys.p2p.iceConnected)),"disconnected"!=e.target.iceConnectionState&&"closed"!=e.target.iceConnectionState&&"failed"!=e.target.iceConnectionState||(this.status=$xirsys.p2p.DISCONNECTED,$xirsys.events.getInstance().emit($xirsys.p2p.iceDisconnected))},onUserMediaSuccess:function(e){this.rtc.localVideo&&this.rtc.useVideo&&(attachMediaStream(this.rtc.localVideo,e),this.rtc.localStream=e)},onUserMediaError:function(){this.error("doGetUserMedia","Could not get user media")},doPeerConnection:function(e){this.getIceServers(function(t){this.signal.send("session",{type:"ice",ice:t},this.rtc.peer,this.rtc.connType),this.onIceServers(t),e()}.bind(this))},onPeerConnectionError:function(){this.error("doPeerConnection","Could not create peer connection")},doGetUserMedia:function(){var e={audio:this.rtc.useAudio,video:{mandatory:{},optional:[]}};this.rtc.screenshare&&(e.video.mandatory={maxWidth:window.screen.width,maxHeight:window.screen.height,maxFrameRate:3},"chrome"===webrtcDetectedBrowser?e.video.mandatory.chromeMediaSource="screen":e.video.mandatory.mediaSource="screen",e.audio=!1);try{if(!this.rtc.useAudio&&!this.rtc.useVideo)return;getUserMedia(e,this.onUserMediaSuccess.bind(this),this.onUserMediaError.bind(this))}catch(e){this.onUserMediaError()}},setLocalAndSendMessage:function(e){this.rtc.peerConn.setLocalDescription(e),this.signal.send("session",e,this.rtc.peer,this.rtc.connType)},mergeConstraints:function(e,t){var n=e;for(var s in t.mandatory)n.mandatory[s]=t.mandatory[s];return n.optional.concat(t.optional),n},setConstraints:function(){this.rtc.sdpConstraints="{'mandatory': {'OfferToReceiveAudio':"+(!!this.rtc.useAudio).toString()+", 'OfferToReceiveVideo':"+(!!this.rtc.useVideo).toString()+" }}"},error:function(e,t){$xirsys.events.getInstance().emit($xirsys.p2p.error,e,t)}},statics:{PEER:"peer",CLIENT:"client",DISCONNECTED:"disconnected",CONNECTED:"connected",CALLING:"calling",ANSWERING:"answering",offer:"p2p.offer",answer:"p2p.answer",error:"p2p.error",iceConnected:"p2p.iceConnected",iceDisconnected:"p2p.iceDisconnected",dataChannelError:"p2p.dataChannelError",dataChannelMessage:"p2p.dataChannelMessage",dataChannelOpen:"p2p.dataChannelOpen",dataChannelClose:"p2p.dataChannelClose",requestDenied:"p2p.requestDenied",publish:"pub",subscribe:"sub",direct:null}})}();var RTCPeerConnection=RTCPeerConnection||null,RTCIceCandidate=RTCIceCandidate||null,RTCSessionDescription=RTCSessionDescription||null,getUserMedia=getUserMedia||null,attachMediaStream=null,detachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null;navigator.mozGetUserMedia?(console.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),attachMediaStream=function(e,t){console.log("Attaching media stream"),e.mozSrcObject=t,e.play()},detachMediaStream=function(e){console.log("detaching media stream"),e.pause(),e.mozSrcObject=null},reattachMediaStream=function(e,t){console.log("Reattaching media stream"),e.mozSrcObject=t.mozSrcObject,e.play()},MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]})):navigator.webkitGetUserMedia?(console.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(e,t){void 0!==e.srcObject?e.srcObject=t:void 0!==e.mozSrcObject?e.mozSrcObject=t:void 0!==e.src?e.src=URL.createObjectURL(t):console.log("Error attaching stream to element.")},detachMediaStream=function(e){console.log("detaching media stream"),e.pause(),void 0!==e.srcObject?e.srcObject=null:void 0!==e.mozSrcObject?e.mozSrcObject=null:void 0!==e.src&&(e.src=null)},reattachMediaStream=function(e,t){e.src=t.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):console.log("Browser does not appear to be WebRTC-capable"),function(){$xirsys.class.create({namespace:"databind",inherits:$xirsys.events,constructor:function(e,t){this.init(e,t)},methods:{init:function(e,t){this.id=e,this.cb=t,this.attr="data-bind-"+e,this.msg=e+":change",document.addEventListener?document.addEventListener("change",this.change_handler.bind(this),!1):document.attachEvent("onChange",this.change_handler.bind(this)),$xirsys.events.getInstance().on(this.msg,this.msg_handler.bind(this))},change_handler:function(e){var t=e.target||e.srcElement,n=t.getAttribute(this.attr);n&&""!==n&&$xirsys.events.getInstance().emit(this.msg,n,t.value)},msg_handler:function(e,t,n){var s,i=document.querySelectorAll("["+this.attr+"='"+t+"']");this.cb&&this.cb.call(this,n);for(var r=0,o=i.length;r<o;r++)s=i[r].tagName.toLowerCase(),"input"===s||"textarea"===s||"select"===s?i[r].value=n:i[r].innerHTML=n}}})}(),function(){var e=$xirsys.class.create({namespace:"connection",inherits:$xirsys.signal,constructor:function(t,n,s){console.log(n),e.Super.constructor.call(this,n),this.inst=t,this.opts=s||{},this.opts.secure=s.secure||1,this.peers={}},methods:{disconnect:function(){this.close()},emit:function(e,t,n){switch(e){case"message":t.to?this.send(e,t,t.to,t.type):this.send(e,t);break;case"create":this.createRoom(t,n);break;case"join":this.joinRoom(t,n);break;case"leave":this.disconnect();break;default:this.send(e,t)}},on:function(e,t){$xirsys.events.getInstance().on(e,t)},getSessionid:function(){return this.sessionId=this.sessionId||this.xirsys_opts&&this.xirsys_opts.username||(new Date).getTime(),this.sessionId},createRoom:function(e,t){var n=this,s=$xirsys.simplewebrtc.roomUrl;"string"!=typeof s&&(s=s(e)),this.inst.xirsysRequest(s,function(s){n.inst.xirsysRequest($xirsys.simplewebrtc.iceUrl,function(i){if("error"==i.s)return void console.error("Could not get ICE string",i.v);n.setupRoom(e,i.v.iceServers),t.apply(n,["error"==s.s&&"path_exists"!=s.v?s.v:null,e])},n.xirsys_opts)},n.xirsys_opts)},joinRoom:function(e,t){var n=this;this.inst.xirsysRequest($xirsys.simplewebrtc.iceUrl,function(s){if("error"==s.s)return void console.error("Could not get ICE string",s.v);n.setupRoom(e,s.v.iceServers),n.joinCB=t},n.xirsys_opts)},setupRoom:function(e,t){this.opts.room=e,this.opts.username=this.opts.username||this.getSessionid(),this.peers={},this.connect(this.opts);var n=t.filter(function(e){return e.url.startsWith("stun")}),s=t.filter(function(e){return e.url.startsWith("turn")});$xirsys.events.getInstance().emit("stunservers",n),$xirsys.events.getInstance().emit("turnservers",s)},getIceServers:function(){this.inst.xirsysRequest($xirsys.simplewebrtc.iceUrl,function(e){for(var t=e.v.iceServers,n=t.length,s=[],i=[],r=0;r<n;r++)t[r].url.startsWith("stun")?s.push(t[r]):i.push(t[r]);$xirsys.events.getInstance().emit("stunservers",s),setInterval(function(){$xirsys.events.getInstance().emit("turnservers",i)},50)},self.xirsys_opts)},addPeer:function(e){if(e!=this.opts.username){for(var t in this.peers)if(t==e)return;this.peers[e]={type:"video"}}},removePeer:function(e){for(var t in this.peers)if(t==e)return void(this.peers[t]=null)},onMessage:function(t){e.Super.onMessage.call(),$xirsys.events.getInstance().emit(t.type,t.data)},onOpen:function(){e.Super.onOpen.call(),$xirsys.events.getInstance().emit("open")},onPeers:function(t){e.Super.onPeers.call(this,t);for(var n=0,s=t.users.length;n<s;n++)this.addPeer(t.users[n]);this.joinCB&&this.joinCB.apply(this,[null,{clients:this.peers}])},onPeerConnected:function(t){e.Super.onPeerConnected.call(this,t),this.addPeer(t)},onPeerRemoved:function(t){e.Super.onPeerRemoved.call(this,t),$xirsys.events.getInstance().emit("remove",t)}}})}(),function(){var e=$xirsys.class.create({namespace:"ui",statics:{parse:function(t,n){var s=e.buildNode(t,n);s&&n.children&&n.children.constructor==Array&&n.children.forEach(function(t){e.parse(s,t)})},buildNode:function(e,t){if("string"==typeof t)return e.append(document.createTextNode(t)),null;var n=document.createElement(t.node||"div");return Object.keys(t).filter(function(e){return"node"!=e&&"children"!=e&&t.hasOwnProperty(e)}).map(function(e){n.setAttribute(e,t[e])}),e.append(n),n}}})}(),function(){var e=$xirsys.class.create({namespace:"model",inherits:$xirsys.databind,constructor:function(t,n){e.Super.init.call(this,t,n),this.id=t},fields:{attrs:{}},methods:{set:function(e,t){this.attrs[e]=t,$xirsys.events.getInstance().emit(this.id+":change",e,t,this)},get:function(e){return this.attrs[e]}}})}(),function(){$xirsys.class.create({namespace:"simplewebrtc",constructor:function(e){var t=$xirsys.simplewebrtc;e&&(t.tokenUrl=e+"?type=token",t.iceUrl=e+"?type=ice",t.roomUrl=e+"?type=room",t.wsUrl=e+"?type=signal")},fields:{connectionTypes:{default:"default",direct:"direct",server:"server"},token:"",ice:[],xirsys_opts:null},methods:{connect:function(e,t,n){this.xirsys_opts=e,t=t||{};var s=this;s.xirsysRequest($xirsys.simplewebrtc.wsUrl,function(i){s.ws=i.v,t.url="ws"+s.ws.substr(2,s.ws.length),t.connection=new $xirsys.connection(s,null,e),s.ref=new SimpleWebRTC(t),n.apply(s,s.ref)})},on:function(e,t){this.ref.on(e,t)},getDomId:function(e){return this.ref.getDomId(e)},capabilities:function(){return this.ref.capabilities},createRoom:function(e,t){var n=this;e&&(this.xirsys_opts.room=e),n.ref.createRoom(e,t)},prepareRoom:function(e){e&&(this.prepare_room=e,this.ref.sessionReady=!0)},joinRoom:function(e){var t=this;e&&(this.xirsys_opts.channel=e),t.ref.joinRoom(e)},leaveRoom:function(){this.ref.leaveRoom()},xirsysRequest:function(e,t,n){var s=this.xirsys_opts;$xirsys.ajax.do({url:e,method:"PUT",headers:$xirsys.authHeader(s),data:n}).done(t)},getLocalScreen:function(){return this.ref.getLocalScreen()},stopScreenShare:function(){this.ref.stopScreenShare()},shareScreen:function(e){this.ref.shareScreen(e)}},statics:{tokenUrl:function(e,t){return $xirsys.url("_token/"+e,{k:t})},iceUrl:$xirsys.url("_turn"),wsUrl:$xirsys.url("_host",{type:"signal"}),roomUrl:function(e){return $xirsys.url("_ns/"+e)}}})}();